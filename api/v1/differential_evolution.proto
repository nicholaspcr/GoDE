syntax = "proto3";

package api.v1;

import "api/v1/definitions.proto";
import "api/v1/differential_evolution_config.proto";
import "google/api/annotations.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

option go_package = "pkg/api";

service DifferentialEvolutionService {
  rpc ListSupportedAlgorithms(google.protobuf.Empty) returns (ListSupportedAlgorithmsResponse) {
    option (google.api.http) = {get: "/v1/de/supported/algorithms"};
  }
  rpc ListSupportedVariants(google.protobuf.Empty) returns (ListSupportedVariantsResponse) {
    option (google.api.http) = {get: "/v1/de/supported/variants"};
  }
  rpc ListSupportedProblems(google.protobuf.Empty) returns (ListSupportedProblemsResponse) {
    option (google.api.http) = {get: "/v1/de/supported/problems"};
  }

  // Async execution RPCs
  rpc RunAsync(RunAsyncRequest) returns (RunAsyncResponse){
    option (google.api.http) = {
      post: "/v1/de/run"
      body: "*"
    };
  }

  rpc StreamProgress(StreamProgressRequest) returns (stream StreamProgressResponse){
    option (google.api.http) = {get: "/v1/de/executions/{execution_id}/progress"};
  }

  rpc GetExecutionStatus(GetExecutionStatusRequest) returns (GetExecutionStatusResponse){
    option (google.api.http) = {get: "/v1/de/executions/{execution_id}"};
  }

  rpc GetExecutionResults(GetExecutionResultsRequest) returns (GetExecutionResultsResponse){
    option (google.api.http) = {get: "/v1/de/executions/{execution_id}/results"};
  }

  rpc ListExecutions(ListExecutionsRequest) returns (ListExecutionsResponse){
    option (google.api.http) = {get: "/v1/de/executions"};
  }

  rpc CancelExecution(CancelExecutionRequest) returns (google.protobuf.Empty){
    option (google.api.http) = {
      post: "/v1/de/executions/{execution_id}/cancel"
      body: "*"
    };
  }

  rpc DeleteExecution(DeleteExecutionRequest) returns (google.protobuf.Empty){
    option (google.api.http) = {delete: "/v1/de/executions/{execution_id}"};
  }
}

message ListSupportedAlgorithmsResponse {
  repeated string algorithms = 1;
}

message Variant {
  string name = 1;
  string description = 2;
}

message ListSupportedVariantsResponse {
  repeated Variant variants = 1;
}

message Problem {
  string name = 1;
  string description = 2;
}

message ListSupportedProblemsResponse {
  repeated Problem problems = 1;
}

message RunAsyncRequest {
  string algorithm = 1;
  string variant = 2;
  string problem = 3;
  DEConfig de_config = 4;
  // idempotency_key is an optional client-provided key for deduplication.
  // If a prior execution with the same key exists for this user it is returned
  // instead of creating a new one.
  string idempotency_key = 5;
  // max_execution_seconds limits how long the execution may run.
  // Zero means the server default applies.
  int64 max_execution_seconds = 6;
}

message GetExecutionResultsResponse {
  Pareto pareto = 1;
}

// Execution status enum
enum ExecutionStatus {
  EXECUTION_STATUS_UNSPECIFIED = 0;
  EXECUTION_STATUS_PENDING = 1;
  EXECUTION_STATUS_RUNNING = 2;
  EXECUTION_STATUS_COMPLETED = 3;
  EXECUTION_STATUS_FAILED = 4;
  EXECUTION_STATUS_CANCELLED = 5;
}

// Execution metadata
message Execution {
  string id = 1;
  string user_id = 2;
  ExecutionStatus status = 3;
  DEConfig config = 4;
  google.protobuf.Timestamp created_at = 5;
  google.protobuf.Timestamp updated_at = 6;
  google.protobuf.Timestamp completed_at = 7;
  string error = 8;
  uint64 pareto_id = 9;
  string algorithm = 10;
  string variant = 11;
  string problem = 12;
  string idempotency_key = 13;
  int64 max_execution_seconds = 14;
}

// Progress update during execution
message StreamProgressResponse {
  string execution_id = 1;
  int32 current_generation = 2;
  int32 total_generations = 3;
  int32 completed_executions = 4;
  int32 total_executions = 5;
  repeated Vector partial_pareto = 6;
  google.protobuf.Timestamp updated_at = 7;
}

// Async execution responses
message RunAsyncResponse {
  string execution_id = 1;
}

message StreamProgressRequest {
  string execution_id = 1;
}

message GetExecutionStatusRequest {
  string execution_id = 1;
}

message GetExecutionStatusResponse {
  Execution execution = 1;
  StreamProgressResponse progress = 2;
}

message GetExecutionResultsRequest {
  string execution_id = 1;
}

message ListExecutionsRequest {
  ExecutionStatus status = 1; // Optional filter
  int32 limit = 2;            // Page size (default: 50, max: 100)
  int32 offset = 3;           // Starting position (default: 0)
}

message ListExecutionsResponse {
  repeated Execution executions = 1;
  int32 total_count = 2;      // Total number of executions matching filter
  int32 limit = 3;            // Echoed limit for pagination
  int32 offset = 4;           // Echoed offset for pagination
  bool has_more = 5;          // True if more results available
}

message CancelExecutionRequest {
  string execution_id = 1;
}

message DeleteExecutionRequest {
  string execution_id = 1;
}
